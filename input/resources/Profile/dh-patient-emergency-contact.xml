<?xml version="1.0" encoding="UTF-8"?>
<StructureDefinition xmlns="http://hl7.org/fhir">
    <id value="dh-patient-emergency-contact-1"/>
    <url value="http://ns.electronichealth.net.au/fhir/StructureDefinition/dh-patient-emergency-contact-1"/>
    <version value="1.0.0"/>
    <name value="ADHAPatientEmergencyContact"/>
    <title value="ADHA Patient Emergency Contact"/>
    <status value="draft"/>
    <experimental value="false"/>
    <date value="2023-12-22"/>
    <publisher value="Australian Digital Health Agency"/>
    <contact>
        <telecom>
          <system value="email"/>
          <value value="help@digitalhealth.gov.au"/>
        </telecom>
     </contact>
    <description value="The purpose of this profile is to support the exchange of patient emergency contact information between My Health App and My Health Record."/>
    <copyright value="Copyright Â© 2023 Australian Digital Health Agency - All rights reserved. This content is licensed under a Creative Commons Attribution 4.0 International License. See https://creativecommons.org/licenses/by/4.0/." />
    <fhirVersion value="4.0.1" />
    <kind value="resource"/>
    <abstract value="false"/>
    <type value="Patient"/>
    <baseDefinition value="http://hl7.org.au/fhir/core/StructureDefinition/au-core-patient"/>
    <derivation value="constraint"/>
    <differential>
        <element id="Patient.contact">
            <path value="Patient.contact"/>
            <min value="1"/>
            <constraint>                
                <key value="inv-dh-pec-01"/>
                <severity value="error"/>
                <human
                    value="If a relationship is either 'Next of kin' or 'Emergency Contact', there shall be a second relationship representing additional information, identified using the Emergency Contact Flag extension."/>
                <expression
                    value="relationship.where(coding.where(system='http://terminology.hl7.org/CodeSystem/v2-0131' and code='C') or coding.where(system='http://terminology.hl7.org/CodeSystem/v2-0131' and code='N')).exists() implies relationship.where(extension.url='http://ns.electronichealth.net.au/fhir/StructureDefinition/dh-mhr-emergency-contact-flag-1').exists()"/>
                <source value="http://ns.electronichealth.net.au/fhir/StructureDefinition/dh-patient-emergency-contact-1" />
            </constraint>
            <mustSupport value="true"/>
        </element>
        <element id="Patient.contact.relationship">
            <path value="Patient.contact.relationship"/>
            <slicing>
                <discriminator>
                    <type value="exists"/>
                    <path value="coding"/>
                </discriminator>
                <rules value="open"/>
            </slicing>
            <min value="1"/>
            <mustSupport value="true"/>
        </element>
        
        <!-- First relationship slice -->
        <element id="Patient.contact.relationship:type">
            <path value="Patient.contact.relationship"/>
            <sliceName value="type"/>
            <min value="1"/>
            <type>
                <code value="CodeableConcept"/>
            </type>
            <mustSupport value="true"/>
        </element>
        <element id="Patient.contact.relationship:type.coding">
            <path value="Patient.contact.relationship.coding"/>
            <min value="1"/>
            <mustSupport value="true"/>
            <binding>
                <strength value="required"/>
                <valueSet
                    value="http://ns.electronichealth.net.au/fhir/ValueSet/emergency-contact-type-1"/>
            </binding>
        </element>
        <element id="Patient.contact.relationship:type.coding.system">
            <path value= "Patient.contact.relationship.coding.system"/>
            <min value="1"/>
            <mustSupport value="true"/>
        </element>
        <element id="Patient.contact.relationship:type.coding.code">
            <path value="Patient.contact.relationship.coding.code"/>
            <min value="1"/>
            <mustSupport value="true"/>
        </element>

        <element id="Patient.contact.relationship:type.text">
            <path value="Patient.contact.relationship.text"/>
            <max value="0"/>
        </element>
        
        <!-- Second relationship slice with an extension -->
        <element id="Patient.contact.relationship:text">
            <path value="Patient.contact.relationship"/>
            <sliceName value="text"/>
            <type>
                <code value="CodeableConcept"/>
            </type>
            <mustSupport value="true"/>
        </element> 
        <element id="Patient.contact.relationship:text.extension">
            <path value="Patient.contact.relationship.extension" />
            <slicing>
                <discriminator>
                    <type value="value" />
                    <path value="url" />
                </discriminator>
                <rules value="open" />
            </slicing>
            <min value="1"/>
            <mustSupport value="true"/>
        </element>
        <element id="Patient.contact.relationship:text.extension:emergency-contact-text">
            <path value="Patient.contact.relationship.extension" />
            <sliceName value="emergencyContactFlag" />
            <short value="Emergency contact flag" />
            <min value="1"/>
            <type>
                <code value="Extension" />
                <profile value="http://ns.electronichealth.net.au/fhir/StructureDefinition/dh-mhr-emergency-contact-flag-1" />
            </type>
            <mustSupport value="true"/>
        </element>

        <element id="Patient.contact.relationship:text.coding">
            <path value="Patient.contact.relationship.coding"/>
            <max value="0"/>
        </element>

        <element id="Patient.contact.relationship:text.text">
            <path value="Patient.contact.relationship.text"/>
            <min value="1"/>
            <mustSupport value="true"/>
        </element>

        <element id ="Patient.contact.name">
            <path value="Patient.contact.name"/>
            <min value="1"/>
            <mustSupport value="true"/>
        </element>

        <!-- Setting up the slicing on contact.telecom -->
        <element id="Patient.contact.telecom">
            <path value="Patient.contact.telecom"/>
            <slicing>
                <discriminator>
                    <type value="value"/>
                    <path value="system"/>
                </discriminator>
                <rules value="open"/>
            </slicing>
            <min value="1"/>
            <mustSupport value="true"/>
        </element>
        <!-- First telecom slice on phone -->
        <element id="Patient.contact.telecom:phone">
            <path value="Patient.contact.telecom"/>
            <sliceName value="phone"/>
            <min value="1"/>
            <mustSupport value="true"/>
        </element>
        <element id="Patient.contact.telecom:phone.system">
            <path value="Patient.contact.telecom.system"/>
            <min value="1"/>
            <type>
                <code value="code"/>
            </type>
            <fixedCode value="phone"/>
            <mustSupport value="true"/>
        </element>
        <element id="Patient.contact.telecom:phone.value">
            <path value="Patient.contact.telecom.value"/>
            <min value="1"/>
            <mustSupport value="true"/>
        </element>
        <!-- Second telecom slice on email -->
        <element id="Patient.contact.telecom:email">
            <path value="Patient.contact.telecom"/>   
            <sliceName value ="email"/>
            <mustSupport value="true"/>
        </element> 
        <element id="Patient.contact.telecom:email.system">
            <path value="Patient.contact.telecom.system"/>
            <min value="1"/>
            <type>
                <code value="code"/>
            </type>
            <fixedCode value="email"/>
            <mustSupport value="true"/>
        </element>
        <element id="Patient.contact.telecom:email.value">
            <path value="Patient.contact.telecom.value"/>
            <min value="1"/>
            <mustSupport value="true"/>
        </element>
    </differential>
</StructureDefinition>
